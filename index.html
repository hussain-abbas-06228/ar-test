<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE-edge" />
    <title>GeoAR.js demo</title>
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-look-at-component@0.8.0/dist/aframe-look-at-component.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.6.2/proj4.js"></script>
  </head>

  <body>
    <a-scene
      cursor='rayOrigin: mouse; fuse: true; fuseTimeout: 0;'
      raycaster="objects: [gps-projected-entity-place];"
      vr-mode-ui="enabled: true"
      arjs="sourceType: webcam; videoTexture: true; debugUIEnabled: false;"
    >
      <a-assets>
        <!-- Load your images and icons here -->
        <img id="concessions-icon" src="assets/menu.png" crossorigin="anonymous">
        <img id="friends-icon" src="assets/friends.png" crossorigin="anonymous">
        <img id="hospitality-icon" src="assets/hospitality.png" crossorigin="anonymous">
        <img id="participants-icon" src="assets/participants.png" crossorigin="anonymous">
      </a-assets>

      <a-camera gps-camera rotation-reader></a-camera>

      <!-- Define locations data -->
      <script>
        const locations = [
          {
            type: "Concessions",
            name: "Concessions Name",
            latitude: 24.855041,
            longitude: 67.024227,
            url: "https://ar-js-org.github.io/AR.js-Docs/",
          },
          {
            type: "Friends",
            name: "Friend's Name",
            latitude: 24.853982,
            longitude: 67.024771,
            url: "https://ar-js-org.github.io/AR.js-Docs/",
          },
          {
            type: "Hospitality",
            name: "Restroom",
            latitude: 24.854645,
            longitude: 67.027000,
          },
          {
            type: "Participants",
            name: "Participant's Name",
            latitude: 24.855889,
            longitude: 67.026156,
            url: "https://ar-js-org.github.io/AR.js-Docs/",
          },
        ];

        // Function to calculate distance
        function calculateDistance(userLatitude, userLongitude, location) {
          const wgs84 = "+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs";
          const webMercator =
            "+proj=merc +a=6378137 +b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0.0 +y_0=0 +k=1.0 +units=m +nadgrids=@null +wktext +no_defs";

          const userCoords = proj4(wgs84, webMercator, [userLongitude, userLatitude]);
          const locationCoords = proj4(wgs84, webMercator, [location.longitude, location.latitude]);

          const deltaX = locationCoords[0] - userCoords[0];
          const deltaY = locationCoords[1] - userCoords[1];
          const distance = Math.sqrt(deltaX * deltaX + deltaY * deltaY);

          return {
            deltaX,
            deltaY,
            distance,
          };
        }
      </script>

      <!-- Render locations based on data -->
      <script>
        const userLatitude = 37.7749; // Example user latitude
        const userLongitude = -122.4194; // Example user longitude

        locations.forEach((location, index) => {
          // Create a unique ID for each location
          const id = `location-${index}`;

          // Calculate distance
          const { deltaX, deltaY, distance } = calculateDistance(userLatitude, userLongitude, location);

          // Create location entity
          const locationEntity = document.createElement("a-entity");
          locationEntity.setAttribute("id", id);
          locationEntity.setAttribute("gps-entity-place", {
            latitude: location.latitude,
            longitude: location.longitude,
          });

          // Location type-specific content
          switch (location.type) {
            case "Concessions":
              locationEntity.innerHTML = `
                <a-image src="#concessions-icon" onclick="openURLInNewWindow('${location.url}')"></a-image>
                <a-text position="-1 1 0" value="${location.name}"></a-text>
                <a-text class="distance-text" position="-1 -1 0" value="Distance: ${distance.toFixed(2)} meters"></a-text>
              `;
              break;

            case "Friends":
              locationEntity.innerHTML = `
                <a-image src="#friends-icon" onclick="openURLInNewWindow('${location.url}')"></a-image>
                <a-text position="-1 1 0" value="${location.name}"></a-text>
                <a-text class="distance-text" position="-1 -1 0" value="Distance: ${distance.toFixed(2)} meters"></a-text>
              `;
              break;

            case "Hospitality":
              locationEntity.innerHTML = `
                <a-image src="#hospitality-icon"></a-image>
                <a-text position="-1 1 0" value="${location.name}"></a-text>
                <a-text class="distance-text" position="-1 -1 0" value="Distance: ${distance.toFixed(2)} meters"></a-text>
              `;
              break;

            case "Participants":
              locationEntity.innerHTML = `
                <a-image src="#participants-icon" onclick="openURLInNewWindow('${location.url}')"></a-image>
                <a-text position="-1 1 0" value="${location.name}"></a-text>
                <a-text class="distance-text" position="-1 -1 0" value="Distance: ${distance.toFixed(2)} meters"></a-text>
              `;
              break;

            default:
              // Default handling
              locationEntity.innerHTML = `
                <a-text value="Unknown Location"></a-text>
              `;
          }

          // Append the location entity to the scene
          document.querySelector("a-scene").appendChild(locationEntity);
        });

        // Function to open a URL in a new window
        function openURLInNewWindow(url) {
          window.open(url, "_blank");
        }
      </script>
    </a-scene>
  </body>
</html>
